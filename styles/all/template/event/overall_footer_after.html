{% if FOLDER_PERCENT %}
<script>
(function() {
	'use strict';

	const settings = {
		folder: 'pmbars:{{ CUR_FOLDER_ID|escape('js') }}',
		percent: Number('{{ FOLDER_PERCENT|escape('js') }}'),
		dangerZone: 80
	};

	try {
		const fragment = document.createDocumentFragment();
		const outerDiv = document.createElement('div');
		const innerDiv = document.createElement('div');

		outerDiv.className = 'pmbars-outer';
		innerDiv.className = 'pmbars-inner';

		if (settings.percent > settings.dangerZone) {
			innerDiv.classList.add('pmbars-danger');
		}

		outerDiv.appendChild(innerDiv);
		fragment.appendChild(outerDiv);

		const viewFolder = document.getElementById('viewfolder');
		if (viewFolder) {
			const firstParagraph = viewFolder.querySelector('p');
			if (firstParagraph) {
				firstParagraph.insertAdjacentElement('afterend', outerDiv);

				try {
					const cachedWidth = sessionStorage.getItem(settings.folder);
					const cachedPercent = parseFloat(cachedWidth);

					if (cachedPercent === settings.percent) {
						// If the cached value matches, set width immediately
						innerDiv.style.transition = 'none';
						innerDiv.classList.add('initialized');
					} else {
						// First view or value changed - animate
						requestAnimationFrame(() => {
							innerDiv.classList.add('initialized');
							sessionStorage.setItem(settings.folder, String(settings.percent));
						});
					}
				} catch (e) {
					// Fallback for when sessionStorage is unavailable
					innerDiv.classList.add('initialized');
					console.warn('Session storage unavailable:', e);
				}
			}
		}
	} catch (e) {
		console.error('Error initializing progress bar:', e);
	}
})();
</script>
{% endif %}
